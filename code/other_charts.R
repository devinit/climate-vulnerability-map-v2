list.of.packages <- c("data.table","ggplot2","scales","plotly","htmlwidgets","showtext","listviewer")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)

wd = "~/git/climate-vulnerability-map-v2/"
setwd(wd)

#### Chart setup ####

reds = c(
  "#e84439", "#f8c1b2", "#f0826d", "#bc2629", "#8f1b13", "#fce3dc", "#fbd7cb", "#f6b0a0", "#ec6250", "#dc372d", "#cd2b2a", "#a21e25", "#6b120a"
)
oranges = c(
  "#eb642b", "#f6bb9d", "#f18e5e", "#d85b31", "#973915", "#fde5d4", "#fcdbbf", "#facbad", "#f3a47c", "#ee7644", "#cb5730", "#ac4622", "#7a2e05"
)
yellows = c(
  "#f49b21", "#fccc8e", "#f9b865", "#e48a00", "#a85d00", "#feedd4", "#fee7c1", "#fedcab", "#fac47e", "#f7a838", "#df8000", "#ba6b15", "#7d4712"
)
pinks = c(
  "#c2135b", "#e4819b", "#d64278", "#ad1257", "#7e1850", "#f9cdd0", "#f6b8c1", "#f3a5b6", "#e05c86", "#d12568", "#9f1459", "#8d0e56", "#65093d"
)
purples = c(
  "#893f90", "#c189bb", "#a45ea1", "#7b3b89", "#551f65", "#ebcfe5", "#deb5d6", "#cb98c4", "#af73ae", "#994d98", "#732c85", "#632572", "#42184c"
)
blues = c(
  "#0089cc", "#88bae5", "#5da3d9", "#0071b1", "#0c457b", "#d3e0f4", "#bcd4f0", "#a3c7eb", "#77adde", "#4397d3", "#105fa3", "#00538e", "#0a3a64"
)
greens = c(
  "#109e68", "#92cba9", "#5ab88a", "#1e8259", "#16513a", "#c5e1cb", "#b1d8bb", "#a2d1b0", "#74bf93", "#3b8c61", "#00694a", "#005b3e", "#07482e"
)
greys = c(
  "#6a6569", "#a9a6aa", "#847e84", "#555053", "#443e42", "#d9d4da", "#cac5cb", "#b3b0b7", "#b9b5bb", "#5a545a", "#736e73", "#4e484c", "#302b2e"
)

di_style = theme_bw() +
  theme(
    panel.border = element_blank()
    ,panel.grid.major.x = element_blank()
    ,panel.grid.minor.x = element_blank()
    ,panel.grid.major.y = element_line(colour = greys[2])
    ,panel.grid.minor.y = element_blank()
    ,panel.background = element_blank()
    ,plot.background = element_blank()
    ,axis.line.x = element_line(colour = "black")
    ,axis.line.y = element_blank()
    ,axis.ticks = element_blank()
    ,legend.position = "bottom"
  )

donut_style = di_style +
  theme(
    panel.grid.major.y = element_blank()
    ,axis.line.x = element_blank()
    ,axis.text = element_blank()
  )

rotate_x_text_45 = theme(
  axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)
)
rotate_x_text_90 = theme(
  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
)
#### End chart setup ####

# Load data
dat = fread("input/climate_funding_data_long_format.csv")
dat = subset(dat, year == 2022)
dat = dat[,c("countryname","variable","value_precise")]
dat = subset(dat, variable %in% c(
  "CCA_USD", "Dual_Purpose_USD", "Total_ODA_USD", "Vulnerability_Score_new"
))

dat = dcast(dat, countryname~variable)
dat$CCA_USD = as.numeric(dat$CCA_USD)
dat$Dual_Purpose_USD = as.numeric(dat$Dual_Purpose_USD)
dat$Total_ODA_USD = as.numeric(dat$Total_ODA_USD)
dat$Vulnerability_Score_new = as.numeric(dat$Vulnerability_Score_new)
dat$CCA_USD = dat$CCA_USD + dat$Dual_Purpose_USD
dat$CCA_Share_ODA = dat$CCA_USD / dat$Total_ODA_USD

# Statistical tests
summary(lm(CCA_USD~Vulnerability_Score_new, data=dat))
summary(lm(CCA_USD~Total_ODA_USD, data=dat))

dat$CCA_USD = round(dat$CCA_USD, 2)
dat$Vulnerability_Score_new = round(dat$Vulnerability_Score_new, 2)
dat = dat[order(-dat$Vulnerability_Score_new),]
dat$`Climate vulnerability rank` = paste(1:nrow(dat), "/", nrow(dat))
dat = dat[order(-dat$CCA_USD),]
dat$`Adaptation ODA rank` = paste(1:nrow(dat), "/", nrow(dat))
setnames(
  dat,
  c("countryname", "CCA_USD", "Vulnerability_Score_new"),
  c("Country", "Adaptation ODA", "Climate vulnerability score")
)

# Top recipients of Adaptation Share
# top_adapt_share = dat[order(-dat$CCA_Share_ODA),][1:10,]
# top_adapt_share$Country = factor(top_adapt_share$Country,levels=top_adapt_share$Country)
top_adapt = dat[order(-dat$`Adaptation ODA`),][1:10,]
top_adapt$Country = factor(top_adapt$Country,levels=top_adapt$Country)

# ggplot(top_adapt_share, aes(x=Country, y=CCA_Share_ODA)) +
#   geom_bar(stat="identity",fill=greens[1]) +
#   scale_y_continuous(expand = c(0, 0),labels=percent) +
#   expand_limits(y=c(0, max(top_adapt_share$CCA_Share_ODA*1.1))) +
#   di_style +
#   labs(
#     y="Total Adaptation ODA\n(% ODA)",
#     x="",
#     color=""
#   ) +
#   rotate_x_text_45

bar1 = ggplot(
  top_adapt, 
  aes(
    x=Country, 
    y=`Adaptation ODA`, 
    tooltip1=`Adaptation ODA rank`, 
    tooltip2=`Climate vulnerability score`, 
    tooltip3=`Climate vulnerability rank`)
  ) +
  geom_bar(stat="identity",fill=greens[1]) +
  scale_y_continuous(expand = c(0, 0),labels=dollar) +
  expand_limits(y=c(0, max(top_adapt$`Adaptation ODA`*1.1))) +
  di_style +
  labs(
    y="Total Adaptation ODA\n(US$ millions)",
    x="",
    color=""
  ) +
  rotate_x_text_45
bar1
bar1_html = ggplotly(bar1, tooltip = c(
  "Adaptation ODA",
  "Adaptation ODA rank",
  "Climate vulnerability score", 
  "Climate vulnerability rank"
  )) %>% plotly::layout(autosize=T)
saveWidget(bar1_html, file = "output/adapt_bar.html", selfcontained=F)
tx  <- readLines("output/adapt_bar.html")
tx2  <- gsub(pattern = "adapt_bar_files", replace = "interactive_common", x = tx)
writeLines(tx2, con="output/adapt_bar.html")

# Top vulnerable
top_vuln = dat[order(-dat$`Climate vulnerability score`),][1:10,]
top_vuln$Country = factor(top_vuln$Country,levels=top_vuln$Country)

intersect(top_vuln$Country, top_adapt$Country)

bar2 = ggplot(
  top_vuln, 
  aes(
    x=Country, 
    y=`Climate vulnerability score`, 
    tooltip1=`Climate vulnerability rank`,
    tooltip2=`Adaptation ODA`,
    tooltip3=`Adaptation ODA rank`
    )
) +
  geom_bar(stat="identity",fill=reds[1]) +
  scale_y_continuous(expand = c(0, 0)) +
  expand_limits(y=c(0, max(top_vuln$`Adaptation ODA`*1.1))) +
  di_style +
  labs(
    y="Climate vulnerability score",
    x="",
    color=""
  ) +
  rotate_x_text_45
bar2
bar2_html = ggplotly(bar2, tooltip = c(
  "Climate vulnerability score", 
  "Climate vulnerability rank",
  "Adaptation ODA",
  "Adaptation ODA rank"
)) %>% plotly::layout(autosize=T)
saveWidget(bar2_html, file = "output/vuln_bar.html", selfcontained=F)
tx  <- readLines("output/vuln_bar.html")
tx2  <- gsub(pattern = "vuln_bar_files", replace = "interactive_common", x = tx)
writeLines(tx2, con="output/vuln_bar.html")

