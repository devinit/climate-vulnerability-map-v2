list.of.packages <- c("sp","leaflet", "leaflet.extras2",
                      "data.table","ggplot2","scales",
                      "htmlwidgets",
                      "RColorBrewer", "geojsonio", "reshape2")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)

wd = "~/git/climate-vulnerability-map-v2/"
setwd(wd)

# Load data
dat = fread("input/climate_funding_data_long_format.csv")
dat = subset(dat, year == 2022)
dat = dat[,c("iso3","variable","value_precise")]
dat = subset(dat, variable %in% c(
  "CCA_USD", "CCM_USD", "Dual_Purpose_USD", "Total_Climate_USD", "Vulnerability_Score_new"
))

dat = dcast(dat, iso3~variable)
dat$CCA_USD = as.numeric(dat$CCA_USD)
dat$CCM_USD = as.numeric(dat$CCM_USD)
dat$Dual_Purpose_USD = as.numeric(dat$Dual_Purpose_USD)
dat$Total_Climate_USD = as.numeric(dat$Total_Climate_USD)
dat$Vulnerability_Score_new = as.numeric(dat$Vulnerability_Score_new)
setnames(dat, "iso3", "iso_3")

# Reshape
world_nat = geojsonio::geojson_read("shapefiles/simplified_adm0_polygons.json", what = "sp")
setdiff(unique(dat$iso_3), unique(world_nat$iso_3))
world_nat = merge(world_nat, dat, by="iso_3", all=T)
world_nat = subset(
  world_nat,
  select = c("iso_3", "adm0_name1", "CCA_USD", "CCM_USD", "Dual_Purpose_USD", "Total_Climate_USD", "Vulnerability_Score_new")
)


greens = c(
  "#109e68", "#92cba9", "#5ab88a", "#1e8259", "#16513a", "#c5e1cb", "#b1d8bb", "#a2d1b0", "#74bf93", "#3b8c61", "#00694a", "#005b3e", "#07482e"
)

reds = c(
  "#e84439", "#f8c1b2", "#f0826d", "#bc2629", "#8f1b13", "#fce3dc", "#fbd7cb", "#f6b0a0", "#ec6250", "#dc372d", "#cd2b2a", "#a21e25", "#6b120a"
)


quantile(dat$CCA_USD, probs=c(0, 0.10, 0.20, 0.80, 0.90, 1), na.rm=T)
cca.bins = c(
  0, 0.1, 0.5, 10, 20, 50, 100, 150
)

cca.pal <- colorBin(greens[6:13], domain = c(world_nat$CCA_USD), bins = cca.bins)

popup.labels <- sprintf(
  paste0(
    "<strong>Country:</strong> %s<br/>",
    "<strong>Adaptation ODA (US$ millions):</strong> %s<br/>",
    "<strong>Climate vulnerability:</strong> %s<br/>"
  ),
  world_nat$adm0_name1, dollar(world_nat$CCA_USD, 0.1), round(world_nat$Vulnerability_Score_new, 1)
) %>% lapply(htmltools::HTML)

quantile(dat$Vulnerability_Score_new, probs=c(0, 0.10, 0.20, 0.80, 0.90, 1), na.rm=T)
vul.bins = c(
  35, 40, 45, 50, 55, 60, 65, 75
)

vul.pal <- colorBin(reds[6:13], domain = c(world_nat$Vulnerability_Score_new), bins = vul.bins)


cca_legend_format = labelFormat(
  prefix="$",
  between=" to "
)

vul_legend_format = labelFormat(
  between=" to ",
  digits = 0
)

m <- leaflet(world_nat) %>%
  addMapPane("Vulnerability", zIndex = 0) %>%
  addMapPane("Adaptation", zIndex = 0) %>%
  setView(25, 0, 3) %>%
  addProviderTiles(
    providers$CartoDB.PositronNoLabels,
    options = pathOptions(pane = "Adaptation"),
    layerId = "Adaptation",
  ) %>%
  addProviderTiles(
    providers$CartoDB.PositronNoLabels,
    options = pathOptions(pane = "Vulnerability"),
    layerId = "Vulnerability",
  ) %>%
  addPolygons(
    group = "Adaptation",
    options = pathOptions(pane = "Adaptation"),
    fillColor = ~cca.pal(CCA_USD),
    weight = 0.5,
    opacity = 1,
    color = "#000",
    dashArray = "",
    fillOpacity = 1,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#000",
      dashArray = "",
      fillOpacity = 1,
      bringToFront = TRUE
    ),
    popup = popup.labels,
    popupOptions = popupOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto",
      closeOnClick = TRUE
    )
  )  %>%
  addPolygons(
    group = "Vulnerability",
    options = pathOptions(pane = "Vulnerability"),
    fillColor = ~vul.pal(Vulnerability_Score_new),
    weight = 0.5,
    opacity = 1,
    color = "#000",
    dashArray = "",
    fillOpacity = 1,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#000",
      dashArray = "",
      fillOpacity = 1,
      bringToFront = TRUE,
      sendToBack = TRUE
    ),
    popup = popup.labels,
    popupOptions = popupOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto",
      closeOnClick = TRUE
    )
  ) %>%
  addLegend(
    pal = cca.pal, values = ~CCA_USD,
    labFormat = cca_legend_format,
    opacity = 1,
    title = "Adaptation ODA</br>(US$ millions)",
    position = "bottomleft"
  ) %>%
  addLegend(
    pal = vul.pal, values = ~Vulnerability_Score_new,
    labFormat = vul_legend_format,
    opacity = 1,
    title = "Climate vulnerability<\br>(index)",
    position = "bottomright"
  ) %>%
  addSidebyside(layerId = "sidecontrols",
                rightId = "Vulnerability",
                leftId  = "Adaptation")
m
saveWidget(m, file="output/adapt_v_vuln.html")
